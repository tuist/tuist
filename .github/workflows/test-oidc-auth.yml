name: Test OIDC Authentication

on:
  push:
    branches:
      - feat/oidc-tokens
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  TUIST_CONFIG_TOKEN: ${{ secrets.TUIST_CONFIG_TOKEN }}

jobs:
  test-oidc:
    name: Test OIDC Authentication
    runs-on: namespace-profile-default-macos
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version).app

      - uses: jdx/mise-action@v2

      - name: Restore cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .build
          key: ${{ runner.os }}-cli-${{ hashFiles('.xcode-version') }}-${{ hashFiles('Package.resolved') }}
          restore-keys: ${{ runner.os }}-cli-${{ hashFiles('.xcode-version') }}-

      - name: Install Tuist dependencies
        run: tuist install

      - name: Build Tuist CLI
        run: |
          tuist generate tuist ProjectDescription
          DERIVED_DATA_PATH="$PWD/DerivedData"
          xcodebuild build -workspace Tuist.xcworkspace -scheme ProjectDescription -derivedDataPath "$DERIVED_DATA_PATH"
          xcodebuild build -workspace Tuist.xcworkspace -scheme tuist -derivedDataPath "$DERIVED_DATA_PATH"

      - name: Create tuist-built symlink
        run: ln -s DerivedData/Build/Products/Debug/tuist ./tuist-built

      - name: Test tuist auth login with OIDC
        run: |
          echo "Testing 'tuist auth login' with OIDC authentication..."
          echo "Server URL: $TUIST_URL"
          TUIST_CONFIG_TOKEN="" TUIST_URL="https://staging.tuist.dev" ./tuist-built auth login --verbose

      - name: Verify authentication by running a command
        run: |
          echo "Verifying authentication by running 'tuist bundle list'..."
          TUIST_CONFIG_TOKEN="" TUIST_URL="https://staging.tuist.dev" ./tuist-built bundle list --verbose
          echo "OIDC authentication test completed successfully!"

      - name: Save cache
        id: cache-save
        uses: actions/cache/save@v4
        with:
          path: .build
          key: ${{ steps.cache-restore.outputs.cache-primary-key }}
