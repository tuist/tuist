name: Secret Scanning

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: secret-scanning-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  trufflehog:
    name: TruffleHog
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.fork != true
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: TruffleHog Secret Scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@v3.92.4
        continue-on-error: true
        with:
          extra_args: --results=verified --json
      - name: Comment on PR
        if: steps.trufflehog.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- trufflehog-secret-scan-comment -->';
            const message = `${marker}
            ## :rotating_light: TruffleHog Secret Scan Failed

            **Verified secrets were detected in this pull request.**

            Please take the following actions:
            1. **Rotate the exposed credential(s) immediately** - assume they are compromised
            2. **Remove the secret from your code** - use environment variables or a secrets manager instead
            3. **If the secret was committed previously**, you may need to rewrite git history using \`git filter-repo\` or similar tools

            For more information, check the [workflow run logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c => c.body.includes(marker));

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: message
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }
      - name: Fail if secrets detected
        if: steps.trufflehog.outcome == 'failure'
        run: |
          echo "::error::TruffleHog detected verified secrets in the codebase"
          exit 1
