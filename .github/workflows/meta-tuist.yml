name: Meta Tuist

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - Tuist/**
      - Package.resolved
      - Gemfile*
      - Package.swift
      - Project.swift
      - Sources/**
      - Tests/**
      - features/**
      - fixtures/**
      - .package.resolved
      - .github/workflows/meta-tuist.yml

concurrency:
  group: meta-tuist-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build with Xcode
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v3
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version).app
      - name: Build
        run: |
          make tuist/build

  generate:
    name: Generate with Xcode
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v3
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version).app
      - name: Generate
        run: |
          ARGS="--no-open" make tuist/generate

  test:
    name: Test with Xcode
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v3
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version).app
      - name: Test
        run: |
          ARGS="--skip-test-targets TuistBuildAcceptanceTests TuistGenerateOneAcceptanceTests" make tuist/test

  cache-warm:
    name: Cache warm with latest Tuist
    runs-on: macos-13
    env:
      TUIST_CONFIG_CLOUD_TOKEN: ${{ secrets.TUIST_CONFIG_CLOUD_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      - uses: asdf-vm/actions/install@v2
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version).app
      - uses: actions/cache@v3
        name: 'Cache fetched dependencies folder'
        with:
          path: Tuist/Dependencies/SwiftPackageManager/.build
          key: spm-v1-${{ hashFiles('Tuist/Package.resolves') }}
          restore-keys: spm-v1-${{ hashFiles('Tuist/Package.resolved') }}
      - name: Fetch dependencies
        run: tuist fetch
      - name: Cache warm
        run: tuist cache warm

  cache-warm-sillicon:
    name: Cache warm with latest Tuist on Sillicon
    runs-on: macos-13-xlarge
    env:
      TUIST_CONFIG_CLOUD_TOKEN: ${{ secrets.TUIST_CONFIG_CLOUD_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      - uses: asdf-vm/actions/install@v2
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version).app
      - uses: actions/cache@v3
        name: 'Cache fetched dependencies folder'
        with:
          path: Tuist/Dependencies/SwiftPackageManager/.build
          key: spm-v1-${{ hashFiles('Tuist/Package.resolves') }}
          restore-keys: spm-v1-${{ hashFiles('Tuist/Package.resolved') }}
      - name: Fetch dependencies
        run: tuist fetch
      - name: Cache warm
        run: tuist cache warm
