import Foundation
import ProjectDescription
import TuistCore
import TuistGraph
import TuistSupport
import TuistSupportTesting
import XCTest

@testable import TuistLoader

final class WorkspaceGenerationOptionsManifestMapperTests: TuistTestCase {
    func test_from_whenAutomaticXcodeSchemeIsDefault() throws {
        // Given
        let temporaryPath = try temporaryPath()
        let generatorPaths = GeneratorPaths(manifestDirectory: temporaryPath)
        let manifest = ProjectDescription.Workspace.GenerationOptions.options(
            automaticXcodeSchemes: .default,
            autogeneratedWorkspaceSchemes: .disabled
        )

        // When
        let actual = try TuistGraph.Workspace.GenerationOptions.from(manifest: manifest, generatorPaths: generatorPaths)

        // Then
        XCTAssertEqual(actual, .init(automaticXcodeSchemes: .default, autogeneratedWorkspaceSchemes: .disabled))
    }

    func test_from_whenAutomaticXcodeSchemeIsDisabled() throws {
        // Given
        let temporaryPath = try temporaryPath()
        let generatorPaths = GeneratorPaths(manifestDirectory: temporaryPath)
        let manifest = ProjectDescription.Workspace.GenerationOptions.options(
            automaticXcodeSchemes: .disabled,
            autogeneratedWorkspaceSchemes: .disabled
        )

        // When
        let actual = try TuistGraph.Workspace.GenerationOptions.from(manifest: manifest, generatorPaths: generatorPaths)

        // Then
        XCTAssertEqual(actual, .init(automaticXcodeSchemes: .disabled, autogeneratedWorkspaceSchemes: .disabled))
    }

    func test_from_whenAutomaticXcodeSchemeIsEnabled() throws {
        // Given
        let temporaryPath = try temporaryPath()
        let generatorPaths = GeneratorPaths(manifestDirectory: temporaryPath)
        let manifest = ProjectDescription.Workspace.GenerationOptions.options(
            automaticXcodeSchemes: .enabled,
            autogeneratedWorkspaceSchemes: .disabled
        )

        // When
        let actual = try TuistGraph.Workspace.GenerationOptions.from(manifest: manifest, generatorPaths: generatorPaths)

        // Then
        XCTAssertEqual(actual, .init(automaticXcodeSchemes: .enabled, autogeneratedWorkspaceSchemes: .disabled))
    }

    func test_from_whenAutogenerationOptionsIsEnabled() throws {
        // Given
        let temporaryPath = try temporaryPath()
        let generatorPaths = GeneratorPaths(manifestDirectory: temporaryPath)
        let manifest = ProjectDescription.Workspace.GenerationOptions.options(
            automaticXcodeSchemes: .enabled,
            autogeneratedWorkspaceSchemes: .enabled(
                codeCoverageMode: .all,
                testingOptions: [.parallelizable, .randomExecutionOrdering]
            )
        )

        // When
        let actual = try TuistGraph.Workspace.GenerationOptions.from(manifest: manifest, generatorPaths: generatorPaths)

        // Then
        XCTAssertEqual(
            actual,
            .init(
                automaticXcodeSchemes: .enabled,
                autogeneratedWorkspaceSchemes: .enabled(
                    codeCoverageMode: .all,
                    testingOptions: [.parallelizable, .randomExecutionOrdering]
                )
            )
        )
    }
}
