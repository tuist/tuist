<div id="flaky-tests">
  <.card title={dgettext("dashboard_tests", "Analytics")} icon="chart_arcs" data-part="analytics">
    <:actions>
      <.dropdown
        id="flaky-tests-analytics-environment-dropdown"
        label={@analytics_environment_label}
        secondary_text={dgettext("dashboard_tests", "Environment:")}
      >
        <.dropdown_item
          value="any"
          label={dgettext("dashboard_tests", "Any")}
          patch={"?#{Query.put(@uri.query, "analytics-environment", "any")}"}
          data-selected={@analytics_environment == "any"}
        >
          <:right_icon><.check /></:right_icon>
        </.dropdown_item>
        <.dropdown_item
          value="local"
          label={dgettext("dashboard_tests", "Local")}
          patch={"?#{Query.put(@uri.query, "analytics-environment", "local")}"}
          data-selected={@analytics_environment == "local"}
        >
          <:right_icon><.check /></:right_icon>
        </.dropdown_item>
        <.dropdown_item
          value="ci"
          label={dgettext("dashboard_tests", "CI")}
          patch={"?#{Query.put(@uri.query, "analytics-environment", "ci")}"}
          data-selected={@analytics_environment == "ci"}
        >
          <:right_icon><.check /></:right_icon>
        </.dropdown_item>
      </.dropdown>
      <.date_picker
        id="flaky-tests-analytics-date-range-picker"
        name="analytics-date-range"
        presets={[
          %{
            id: "last-24-hours",
            label: dgettext("dashboard_tests", "Last 24 hours"),
            period: {24, :hour}
          },
          %{
            id: "last-7-days",
            label: dgettext("dashboard_tests", "Last 7 days"),
            period: {7, :day}
          },
          %{
            id: "last-30-days",
            label: dgettext("dashboard_tests", "Last 30 days"),
            period: {30, :day}
          },
          %{
            id: "last-12-months",
            label: dgettext("dashboard_tests", "Last 12 months"),
            period: {12, :month}
          },
          %{id: "custom", label: dgettext("dashboard_tests", "Custom")}
        ]}
        selected_preset={@analytics_preset}
        period={@analytics_period}
        on_period_change="analytics_period_changed"
        max={Date.utc_today()}
      >
        <:actions>
          <.button
            label={dgettext("dashboard_tests", "Cancel")}
            variant="secondary"
            phx-click={
              JS.dispatch("phx:date-picker-cancel",
                detail: %{id: "flaky-tests-analytics-date-range-picker"}
              )
            }
          />
          <.button
            label={dgettext("dashboard_tests", "Apply")}
            phx-click={
              JS.dispatch("phx:date-picker-apply",
                detail: %{id: "flaky-tests-analytics-date-range-picker"}
              )
            }
          />
        </:actions>
      </.date_picker>
    </:actions>
    <.card_section :if={@flaky_runs_analytics.count != 0} data-part="analytics-chart-section">
      <div data-part="legends">
        <.legend
          title={dgettext("dashboard_tests", "Flaky Runs")}
          value={@flaky_runs_analytics.count}
          style="flaky"
        />
      </div>
      <.chart
        id="flaky-runs-chart"
        type="line"
        extra_options={
          %{
            grid: %{
              width: "97%",
              left: "0.4%",
              height: "88%",
              top: "5%"
            },
            xAxis: %{
              boundaryGap: false,
              type: "category",
              axisLabel: %{
                color: "var:noora-surface-label-secondary",
                formatter: "fn:toLocaleDate",
                customValues: [
                  @flaky_runs_analytics.dates |> List.first(),
                  @flaky_runs_analytics.dates |> List.last()
                ],
                padding: [10, 0, 0, 0]
              }
            },
            yAxis: %{
              splitNumber: 4,
              splitLine: %{
                lineStyle: %{
                  color: "var:noora-chart-lines"
                }
              },
              axisLabel: %{
                color: "var:noora-surface-label-secondary"
              }
            },
            legend: %{
              show: false
            },
            tooltip:
              if @analytics_preset == "last-24-hours" do
                %{dateFormat: "hour"}
              else
                %{}
              end
          }
        }
        series={[
          %{
            color: "var:noora-chart-flaky",
            data:
              Enum.zip(
                @flaky_runs_analytics.dates,
                @flaky_runs_analytics.values
              )
              |> Enum.map(&Tuple.to_list/1),
            name: dgettext("dashboard_tests", "Flaky runs"),
            type: "line",
            smooth: 0.1,
            symbol: "none"
          }
        ]}
        y_axis_min={0}
      />
    </.card_section>
    <.empty_card_section
      :if={@flaky_runs_analytics.count == 0}
      title={dgettext("dashboard_tests", "No data yet")}
    >
      <:image>
        <img src="/images/empty_line_chart_light.png" data-theme="light" />
        <img src="/images/empty_line_chart_dark.png" data-theme="dark" />
      </:image>
    </.empty_card_section>
  </.card>

  <.card
    title={dgettext("dashboard_tests", "Flaky Tests")}
    icon="progress_x"
    data-part="flaky-tests"
  >
    <.card_section data-part="flaky-tests-section">
      <div data-part="filters">
        <.form for={%{}} phx-change="search-flaky-tests" phx-debounce="200">
          <.text_input
            type="search"
            id="search-flaky-tests"
            name="search"
            placeholder={dgettext("dashboard_tests", "Search...")}
            show_suffix={false}
            data-part="search"
            value={@flaky_tests_filter}
          />
        </.form>
        <.dropdown
          id="flaky-tests-sort-by"
          label={
            case @flaky_tests_sort_by do
              "name" -> dgettext("dashboard_tests", "Test Case")
              "last_flaky_at" -> dgettext("dashboard_tests", "Last flaky run")
              _ -> dgettext("dashboard_tests", "Flaky runs")
            end
          }
          secondary_text={dgettext("dashboard_tests", "Sort by:")}
        >
          <.dropdown_item
            value="flaky_runs_count"
            label={dgettext("dashboard_tests", "Flaky runs")}
            patch={sort_by_patch(@uri, "flaky_runs_count")}
            data-selected={@flaky_tests_sort_by == "flaky_runs_count"}
          >
            <:right_icon><.check /></:right_icon>
          </.dropdown_item>
          <.dropdown_item
            value="name"
            label={dgettext("dashboard_tests", "Test Case")}
            patch={sort_by_patch(@uri, "name")}
            data-selected={@flaky_tests_sort_by == "name"}
          >
            <:right_icon><.check /></:right_icon>
          </.dropdown_item>
          <.dropdown_item
            value="last_flaky_at"
            label={dgettext("dashboard_tests", "Last flaky run")}
            patch={sort_by_patch(@uri, "last_flaky_at")}
            data-selected={@flaky_tests_sort_by == "last_flaky_at"}
          >
            <:right_icon><.check /></:right_icon>
          </.dropdown_item>
        </.dropdown>
        <.filter_dropdown
          id="filter-dropdown"
          label={dgettext("dashboard_tests", "Filter")}
          available_filters={@available_filters}
          active_filters={@active_filters}
        />
      </div>
      <div :if={Enum.any?(@active_filters)} data-part="active-filters">
        <.active_filter :for={filter <- @active_filters} filter={filter} />
      </div>

      <div :if={not Enum.empty?(@flaky_tests)} data-part="flaky-tests-table">
        <.table
          id="flaky-tests-table"
          rows={@flaky_tests}
          row_navigate={
            fn test_case ->
              url(
                ~p"/#{@selected_project.account.name}/#{@selected_project.name}/tests/test-cases/#{test_case.id}"
              )
            end
          }
        >
          <:col
            :let={test_case}
            label={dgettext("dashboard_tests", "Test Case")}
            patch={
              @flaky_tests_sort_by == "name" &&
                column_sort_patch(assigns, "name")
            }
            icon={
              @flaky_tests_sort_by == "name" &&
                sort_icon(@flaky_tests_sort_order)
            }
          >
            <.text_and_description_cell
              label={test_case.name}
              description={
                case {test_case.module_name, test_case.suite_name} do
                  {module_name, suite_name} when module_name != "" and suite_name != "" ->
                    "#{module_name} \u2022 #{suite_name}"

                  {module_name, _} when module_name != "" ->
                    module_name

                  _ ->
                    nil
                end
              }
            />
          </:col>
          <:col
            :let={test_case}
            label={dgettext("dashboard_tests", "Flaky runs")}
            patch={
              @flaky_tests_sort_by == "flaky_runs_count" &&
                column_sort_patch(assigns, "flaky_runs_count")
            }
            icon={
              @flaky_tests_sort_by == "flaky_runs_count" &&
                sort_icon(@flaky_tests_sort_order)
            }
          >
            <.text_cell label={test_case.flaky_runs_count} />
          </:col>
          <:col
            :let={test_case}
            label={dgettext("dashboard_tests", "Last flaky run")}
            patch={
              @flaky_tests_sort_by == "last_flaky_at" &&
                column_sort_patch(assigns, "last_flaky_at")
            }
            icon={
              @flaky_tests_sort_by == "last_flaky_at" &&
                sort_icon(@flaky_tests_sort_order)
            }
          >
            <.link_button
              :if={test_case.last_flaky_run_id}
              navigate={
                ~p"/#{@selected_project.account.name}/#{@selected_project.name}/tests/test-runs/#{test_case.last_flaky_run_id}"
              }
              label={Tuist.Utilities.DateFormatter.from_now(test_case.last_flaky_at)}
              underline
              variant="secondary"
              size="large"
              data-part="last-flaky-run-link"
            />
            <span :if={is_nil(test_case.last_flaky_run_id)}>
              {Tuist.Utilities.DateFormatter.from_now(test_case.last_flaky_at)}
            </span>
          </:col>
        </.table>
        <.pagination_group
          :if={@flaky_tests_meta.total_pages > 1}
          current_page={@flaky_tests_page}
          number_of_pages={@flaky_tests_meta.total_pages}
          page_patch={
            fn page ->
              "?#{Query.put(@uri.query, "page", page)}"
            end
          }
        />
      </div>

      <div :if={Enum.empty?(@flaky_tests)} data-part="empty-flaky-tests">
        <.empty_card_section
          title={dgettext("dashboard_tests", "No flaky tests")}
          get_started_href="https://docs.tuist.dev/en/guides/features/insights#tests"
          data-part="empty-flaky-tests-table-card-section"
        >
          <:image>
            <img src="/images/empty_table_light.png" data-theme="light" />
            <img src="/images/empty_table_dark.png" data-theme="dark" />
          </:image>
        </.empty_card_section>
      </div>
    </.card_section>
  </.card>
</div>
