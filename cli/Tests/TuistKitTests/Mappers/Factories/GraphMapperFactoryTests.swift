import Foundation
import Path
import TuistAutomation
import TuistConfig
import TuistLoader
import TuistServer
import XcodeGraph
import XCTest

#if canImport(TuistCacheEE)
    import TuistCacheEE
#endif

@testable import TuistCore
@testable import TuistGenerator
@testable import TuistKit
@testable import TuistTesting

final class GraphMapperFactoryTests: TuistUnitTestCase {
    var subject: GraphMapperFactory!

    override func setUp() {
        super.setUp()
        subject = GraphMapperFactory()
    }

    override func tearDown() {
        subject = nil
        super.tearDown()
    }

    func test_default_contains_the_update_workspace_projects_graph_mapper() {
        // When
        let got = subject.default(config: .test())

        // Then
        XCTAssertContainsElementOfType(got, UpdateWorkspaceProjectsGraphMapper.self)
    }

    func test_default_contains_the_explicit_dependency_graph_mapper_when_explcit_dependencies_are_enforced() {
        // When
        let got = subject.default(
            config: .test(project: .generated(.test(generationOptions: .test(enforceExplicitDependencies: true))))
        )

        // Then
        XCTAssertContainsElementOfType(got, ExplicitDependencyGraphMapper.self)
    }

    func test_default_does_not_contain_the_explicit_dependency_graph_mapper() {
        // When
        let got = subject.default(config: .test())

        // Then
        XCTAssertDoesntContainElementOfType(got, ExplicitDependencyGraphMapper.self)
    }

    func test_default_contains_the_modulemap_mapper() {
        // When
        let got = subject.default(config: .test())

        // Then
        XCTAssertContainsElementOfType(got, ModuleMapMapper.self)
    }
}

#if canImport(TuistCacheEE)
    final class CacheGraphMapperFactoryTests: TuistUnitTestCase {
        private var subject: CacheGraphMapperFactory!
        private var cacheStorage: MockCacheStoring!

        override func setUp() {
            super.setUp()
            cacheStorage = MockCacheStoring()
            subject = CacheGraphMapperFactory(contentHasher: ContentHasher())
        }

        override func tearDown() {
            subject = nil
            cacheStorage = nil
            super.tearDown()
        }

        func test_generation_contains_the_graph_mapper_to_auto_generate_schemes() {
            // Given
            let includedTargets: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.generation(
                config: .test(project: .testGeneratedProject()),
                cacheProfile: .onlyExternal,
                cacheSources: includedTargets,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            let mapper = XCTAssertContainsElementOfType(got, AutogeneratedWorkspaceSchemeGraphMapper.self)
            XCTAssertNotNil(mapper)
        }

        func test_cache_contains_the_filter_target_dependenies_tree_graph_mapper() {
            // Given
            let includedTargets: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.binaryCacheWarming(
                config: .test(),
                targets: [.iOS: includedTargets],
                cacheSources: includedTargets,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            let mapper = XCTAssertContainsElementOfType(got, FocusTargetsGraphMappers.self)
            XCTAssertEqual(mapper?.includedTargets, includedTargets)
        }

        func test_cache_contains_the_tree_shaking_mapper() {
            // Given
            let includedTargets: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.binaryCacheWarming(
                config: .test(),
                targets: [.iOS: includedTargets],
                cacheSources: includedTargets,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            XCTAssertContainsElementOfType(
                got, TreeShakePrunedTargetsGraphMapper.self, after: FocusTargetsGraphMappers.self
            )
        }

        func test_cache_contains_the_generate_cacheable_schemes_graph_mapper() {
            // Given
            let includedTargets: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.binaryCacheWarming(
                config: .test(),
                targets: [.iOS: includedTargets],
                cacheSources: includedTargets,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            let mapper = XCTAssertContainsElementOfType(got, GenerateCacheableSchemesGraphMapper.self)
            XCTAssertEqual(mapper?.targets, [.iOS: includedTargets])
        }

        func test_focus_contains_the_filter_target_dependenies_tree_graph_mapper() {
            // Given
            let config = Tuist.test()
            let cacheSources: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.generation(
                config: config,
                cacheProfile: .none,
                cacheSources: cacheSources,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            let mapper = XCTAssertContainsElementOfType(got, FocusTargetsGraphMappers.self)
            XCTAssertEqual(mapper?.includedTargets, cacheSources)
        }

        func test_focus_contains_the_cache_tree_shaking_graph_mapper() {
            // Given
            let config = Tuist.test()
            let cacheSources: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.generation(
                config: config,
                cacheProfile: .onlyExternal,
                cacheSources: cacheSources,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            XCTAssertContainsElementOfType(
                got, TreeShakePrunedTargetsGraphMapper.self, after: FocusTargetsGraphMappers.self
            )
            XCTAssertContainsElementOfType(
                got,
                TreeShakePrunedTargetsGraphMapper.self,
                after: TargetsToCacheBinariesGraphMapper.self
            )
        }

        func test_focus_contains_the_cache_mapper() {
            // Given
            let config = Tuist.test()
            let cacheSources: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.generation(
                config: config,
                cacheProfile: .onlyExternal,
                cacheSources: cacheSources,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            XCTAssertContainsElementOfType(
                got, TargetsToCacheBinariesGraphMapper.self, after: FocusTargetsGraphMappers.self
            )
        }

        func test_automation_contains_the_tests_cache_graph_mapper() throws {
            // Given
            let config = Tuist.test()

            // When
            let got = subject.automation(
                config: config,
                ignoreBinaryCache: false,
                ignoreSelectiveTesting: false,
                testPlan: nil,
                includedTargets: [],
                excludedTargets: [],
                configuration: "Debug",
                cacheStorage: cacheStorage,
                destination: nil
            )

            // Then
            _ = XCTAssertContainsElementOfType(got, TestsCacheGraphMapper.self)
        }

        func test_automation_contains_the_filter_target_dependenies_tree_graph_mapper() throws {
            // Given
            let config = Tuist.test()
            let includedTargets: Set<TargetQuery> = [.named("MyTarget")]

            // When
            let got = subject.automation(
                config: config,
                ignoreBinaryCache: false,
                ignoreSelectiveTesting: true,
                testPlan: nil,
                includedTargets: includedTargets,
                excludedTargets: [],
                configuration: "Debug",
                cacheStorage: cacheStorage,
                destination: nil
            )

            // Then - FocusTargetsGraphMappers runs after TestsCacheGraphMapper
            XCTAssertContainsElementOfType(
                got, FocusTargetsGraphMappers.self, after: TestsCacheGraphMapper.self
            )
        }

        func test_automation_runs_tests_cache_after_static_xcframework_module_map_mapper() throws {
            // Given
            let config = Tuist.test()

            // When
            let got = subject.automation(
                config: config,
                ignoreBinaryCache: false,
                ignoreSelectiveTesting: false,
                testPlan: nil,
                includedTargets: [],
                excludedTargets: [],
                configuration: "Debug",
                cacheStorage: cacheStorage,
                destination: nil
            )

            // Then - TestsCacheGraphMapper should run after StaticXCFrameworkModuleMapGraphMapper for consistent hashing
            XCTAssertContainsElementOfType(
                got, TestsCacheGraphMapper.self, after: StaticXCFrameworkModuleMapGraphMapper.self
            )
        }

        func test_automation_contains_the_tests_cache_tree_shaking_mapper() throws {
            // Given
            let config = Tuist.test()

            // When
            let got = subject.automation(
                config: config,
                ignoreBinaryCache: false,
                ignoreSelectiveTesting: false,
                testPlan: nil,
                includedTargets: [],
                excludedTargets: [],
                configuration: "Debug",
                cacheStorage: cacheStorage,
                destination: nil
            )

            // Then
            XCTAssertContainsElementOfType(
                got, TreeShakePrunedTargetsGraphMapper.self, after: FocusTargetsGraphMappers.self
            )
        }

        func test_default_contains_focus_mappers_when_targets_specified() {
            // Given
            let includedTargets: Set<TargetQuery> = [.named("MyTarget")]

            // When
            let got = subject.default(config: .test(), includedTargets: includedTargets)

            // Then
            let mapper = XCTAssertContainsElementOfType(got, FocusTargetsGraphMappers.self)
            XCTAssertEqual(mapper?.includedTargets, includedTargets)
        }

        func test_default_does_not_contain_focus_mappers_when_no_targets_specified() {
            // When
            let got = subject.default(config: .test(), includedTargets: [])

            // Then
            XCTAssertDoesntContainElementOfType(got, FocusTargetsGraphMappers.self)
        }

        func test_default_contains_explicit_dependency_mapper_when_enforced() {
            // Given
            let config = Tuist.test(
                project: .generated(.test(generationOptions: .test(enforceExplicitDependencies: true)))
            )

            // When
            let got = subject.default(config: config, includedTargets: [])

            // Then
            XCTAssertContainsElementOfType(got, ExplicitDependencyGraphMapper.self)
        }

        func test_binaryCacheWarmingPreload_and_generation_use_same_base_mappers() {
            // Given
            let config = Tuist.test()
            let targets: Set<TargetQuery> = [.named("MyTarget")]

            // When
            let preloadMappers = subject.binaryCacheWarmingPreload(
                targetsToBinaryCache: targets,
                config: config
            )
            let generationMappers = subject.generation(
                config: config,
                cacheProfile: .none,
                cacheSources: targets,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then - Both should contain the same hash-affecting mappers in the same order
            let preloadMapperTypes = preloadMappers.prefix(8).map { String(describing: type(of: $0)) }
            let generationMapperTypes = generationMappers.prefix(8).map { String(describing: type(of: $0)) }

            XCTAssertEqual(preloadMapperTypes, generationMapperTypes)
        }

        func test_automation_contains_static_xcframework_module_map_mapper_after_cache_replacement() throws {
            // Given
            let config = Tuist.test()

            // When
            let got = subject.automation(
                config: config,
                ignoreBinaryCache: false,
                ignoreSelectiveTesting: false,
                testPlan: nil,
                includedTargets: [],
                excludedTargets: [],
                configuration: "Debug",
                cacheStorage: cacheStorage,
                destination: nil
            )

            // Then
            XCTAssertContainsElementOfType(
                got,
                StaticXCFrameworkModuleMapGraphMapper.self,
                after: TargetsToCacheBinariesGraphMapper.self
            )
        }

        func test_build_contains_static_xcframework_module_map_mapper_after_cache_replacement() {
            // Given
            let config = Tuist.test()

            // When
            let got = subject.build(
                config: config,
                ignoreBinaryCache: false,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            XCTAssertContainsElementOfType(
                got,
                StaticXCFrameworkModuleMapGraphMapper.self,
                after: TargetsToCacheBinariesGraphMapper.self
            )
        }

        func test_generation_contains_static_xcframework_module_map_mapper_after_cache_replacement() {
            // Given
            let config = Tuist.test()
            let cacheSources: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.generation(
                config: config,
                cacheProfile: .onlyExternal,
                cacheSources: cacheSources,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            XCTAssertContainsElementOfType(
                got,
                StaticXCFrameworkModuleMapGraphMapper.self,
                after: TargetsToCacheBinariesGraphMapper.self
            )
        }

        func test_binaryCacheWarming_contains_static_xcframework_module_map_mapper_after_cache_replacement() {
            // Given
            let includedTargets: Set<TargetQuery> = Set([.named("MyTarget")])

            // When
            let got = subject.binaryCacheWarming(
                config: .test(),
                targets: [.iOS: includedTargets],
                cacheSources: includedTargets,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then
            XCTAssertContainsElementOfType(
                got,
                StaticXCFrameworkModuleMapGraphMapper.self,
                after: TargetsToCacheBinariesGraphMapper.self
            )
        }

        func test_automation_and_binaryCacheWarming_use_same_base_mappers() {
            // Given
            let config = Tuist.test()
            let targets: Set<TargetQuery> = [.named("MyTarget")]

            // When
            let automationMappers = subject.automation(
                config: config,
                ignoreBinaryCache: true,
                ignoreSelectiveTesting: true,
                testPlan: nil,
                includedTargets: targets,
                excludedTargets: [],
                configuration: "Debug",
                cacheStorage: cacheStorage,
                destination: nil
            )
            let cacheMappers = subject.binaryCacheWarming(
                config: config,
                targets: [.iOS: targets],
                cacheSources: targets,
                configuration: "Debug",
                cacheStorage: cacheStorage
            )

            // Then - Both should contain ModuleMapMapper and StaticXCFrameworkModuleMapGraphMapper
            // in the same relative order for consistent hashing
            XCTAssertContainsElementOfType(automationMappers, ModuleMapMapper.self)
            XCTAssertContainsElementOfType(automationMappers, StaticXCFrameworkModuleMapGraphMapper.self)
            XCTAssertContainsElementOfType(cacheMappers, ModuleMapMapper.self)
            XCTAssertContainsElementOfType(cacheMappers, StaticXCFrameworkModuleMapGraphMapper.self)
        }
    }
#endif
