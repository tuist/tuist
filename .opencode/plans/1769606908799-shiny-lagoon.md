# Plan: Simplify SQLite Buffer Stack

## Goal
- Simplify the new SQLite buffer stack and remove defensive/retry behavior.
- Scope limited to buffer stack only: `Cache.SQLiteBuffer` and per-table buffer modules.

## Files in Scope
- `cache/lib/cache/sqlite_buffer.ex`
- `cache/lib/cache/sqlite_bufferable.ex`
- `cache/lib/cache/key_value_buffer.ex`
- `cache/lib/cache/cache_artifacts_buffer.ex`
- `cache/lib/cache/s3_transfers_buffer.ex`

## Plan
1. **Remove retry/backoff behavior in `Cache.SQLiteBuffer`.**
   - Drop `with_retry/4`, `do_with_retry/5`, `busy_error?/1`, and `backoff_ms/2`.
   - Call `buffer_module.write_batch/2` directly in `execute_operation/2` and let exceptions crash the buffer process.
   - Keep telemetry for flush duration, but do not log or rescue failures.

2. **Make queue stats contract explicit and less defensive.**
   - Remove `ensure_total/1` in `Cache.SQLiteBuffer`.
   - Update `Cache.SQLiteBufferable` docs/spec to require `queue_stats/1` to always include `:total`.
   - Keep existing per-buffer stats keys (e.g., `:key_values`, `:cas_artifacts`, `:s3_transfers`) to avoid unnecessary test churn.

3. **Simplify batching helpers in per-table buffers.**
   - Remove `add_operation/3` helpers and build operations directly.
   - Replace `take_map_batch/2` and `take_set_batch/2` with straightforward splits (no pre-checks/guards).
   - Keep batching behavior the same (max batch size), but reduce branching.

4. **Relax input guards where they are purely defensive.**
   - Remove `when is_list(...)` and enum guards in buffer `enqueue_*` functions so invalid inputs can crash rather than be silently rejected by a guard clause.
   - Rely on callers to pass correct types; failures bubble up.

5. **Adjust tests only if they relied on removed safety behavior.**
   - Verify `cache/test/cache/sqlite_buffer_test.exs` still passes with the updated `queue_stats/1` contract.

## Verification
- Run buffer-focused tests: `mix test test/cache/sqlite_buffer_test.exs` (from `cache/`).
- If needed, run related buffer tests touched by changes.
