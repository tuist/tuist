# Plan: Align SQLite writer with buffer pattern

## Goals
- Replace the single SQLite writer with per-table buffers and shared buffer logic (similar to server ClickHouse buffers).
- Preserve current SQLite behavior: insert_all upserts, delete batching, busy-lock retries, and timer/size flush behavior.
- Keep telemetry/metrics continuity while adding per-buffer visibility.
- Remove Cache.SQLiteWriter and update all call sites/tests accordingly.

## Key decisions
- No compatibility shim: remove Cache.SQLiteWriter and migrate all callers/tests to new buffers.
- Keep metric names stable (tuist_cache.sqlite_writer.*), add a buffer tag for per-table visibility.

## Implementation steps
1) Add generic SQLite buffer GenServer
   - New module: cache/lib/cache/sqlite_buffer.ex
   - Responsibilities: timer-driven flush, max batch size, drain on terminate, retry/backoff on busy errors, and telemetry.
   - API (per buffer process): enqueue/1 (GenServer.call), flush/0, queue_stats/0, reset/0 (test-only).
   - Config defaults from :cache, Cache.SQLiteBuffer with optional per-buffer overrides (same keys as current :sqlite_writer).
   - Emit telemetry on flush/retry using existing event names, with metadata %{buffer: buffer_name, operation: op}.

2) Add SQLite buffer contract
   - New module: cache/lib/cache/sqlite_bufferable.ex (behavior or macro).
   - Callbacks for per-buffer logic, e.g.:
     - init_state/0
     - handle_event(state, event)
     - flush_batches(state, max_batch_size) -> {batches, new_state}
     - queue_stats(state)
     - queue_empty?(state)
     - write_batch(operation, entries)
     - buffer_name/0 (used for telemetry tags)

3) Add per-table buffer modules
   - cache/lib/cache/key_value_buffer.ex
     - State: Map keyed by entry key.
     - handle_event dedupes by key.
     - write_batch uses Repo.insert_all(KeyValueEntry) with conflict replace, timestamps set on flush.
   - cache/lib/cache/cache_artifacts_buffer.ex
     - State: cas_accesses Map + cas_deletes MapSet.
     - handle_event removes pending access when delete arrives.
     - flush_batches returns :accesses and :deletes operations in stable order.
     - write_batch uses Repo.insert_all(CacheArtifact) and Repo.delete_all by key list.
   - cache/lib/cache/s3_transfers_buffer.ex
     - State: s3_inserts Map keyed by {type, key} (UUIDv7 + inserted_at) and s3_deletes MapSet of ids.
     - Deduplicate inserts by {type, key}; keep deletes idempotent.
     - write_batch uses Repo.insert_all(S3Transfer) with conflict :nothing and Repo.delete_all by ids.

4) Migrate call sites to per-table buffers
   - cache/lib/cache/key_value_store.ex -> use Cache.KeyValueBuffer.enqueue/2.
   - cache/lib/cache/cache_artifacts.ex -> use Cache.CacheArtifactsBuffer.enqueue_access/3, enqueue_deletes/1, flush/0.
   - cache/lib/cache/s3_transfers.ex -> use Cache.S3TransfersBuffer enqueue helpers and flush/0.
   - cache/lib/cache/s3_transfer_worker.ex -> flush S3TransfersBuffer before pending queries.

5) Remove single writer and update supervision/config
   - Delete cache/lib/cache/sqlite_writer.ex.
   - cache/lib/cache/application.ex: replace Cache.SQLiteWriter with the three buffer children (after Cache.Repo).
   - cache/config/config.exs: remove :cache, :sqlite_writer, add :cache, Cache.SQLiteBuffer defaults and optional per-buffer overrides.
   - cache/lib/cache/prom_ex.ex: replace Cache.SQLiteWriter.PromExPlugin with new buffer plugin.

6) Telemetry and PromEx updates
   - Replace cache/lib/cache/sqlite_writer/prom_ex_plugin.ex with cache/lib/cache/sqlite_buffer/prom_ex_plugin.ex.
   - Keep metric names stable; add buffer tag for per-buffer visibility (and keep operation tag).
   - Polling metrics should aggregate per-buffer pending counts and keep existing total gauge.

7) Test updates
   - Replace sqlite_writer_test with buffer tests (sqlite_buffer_test + per-buffer tests) covering:
     - Dedupe rules, flush behavior, and shutdown drain per buffer.
   - Update existing tests to use new buffer flushes and enqueues:
     - cache/test/cache/key_value_store_test.exs
     - cache/test/cache/s3_transfers_test.exs
     - cache/test/cache/s3_transfer_worker_test.exs
     - cache/test/cache/disk_eviction_worker_test.exs
   - Update cache/test/support/conn_case.ex to Sandbox.allow all buffer processes and reset them between tests.

## Files to add/modify
- Add: cache/lib/cache/sqlite_buffer.ex
- Add: cache/lib/cache/sqlite_bufferable.ex
- Add: cache/lib/cache/key_value_buffer.ex
- Add: cache/lib/cache/cache_artifacts_buffer.ex
- Add: cache/lib/cache/s3_transfers_buffer.ex
- Replace: cache/lib/cache/sqlite_writer/prom_ex_plugin.ex -> cache/lib/cache/sqlite_buffer/prom_ex_plugin.ex
- Remove: cache/lib/cache/sqlite_writer.ex
- Modify: cache/lib/cache/application.ex
- Modify: cache/config/config.exs
- Modify: cache/lib/cache/prom_ex.ex
- Modify: cache/lib/cache/key_value_store.ex
- Modify: cache/lib/cache/cache_artifacts.ex
- Modify: cache/lib/cache/s3_transfers.ex
- Modify: cache/lib/cache/s3_transfer_worker.ex
- Modify: cache/test/support/conn_case.ex
- Modify: cache/test/cache/sqlite_writer_test.exs (replace with buffer-focused tests)
- Modify: cache/test/cache/key_value_store_test.exs
- Modify: cache/test/cache/s3_transfers_test.exs
- Modify: cache/test/cache/s3_transfer_worker_test.exs
- Modify: cache/test/cache/disk_eviction_worker_test.exs

## Verification
- mix test cache/test/cache/sqlite_buffer_test.exs (or new buffer tests)
- mix test cache/test/cache/key_value_store_test.exs
- mix test cache/test/cache/s3_transfers_test.exs
- mix test cache/test/cache/s3_transfer_worker_test.exs
- mix test cache/test/cache/disk_eviction_worker_test.exs
