#!/usr/bin/env bash
# E2E test: Gradle build cache integration
# Tests that Gradle builds can push and pull cache artifacts from the Tuist server

set -euo pipefail

E2E_LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)"
# shellcheck source=../lib/style.sh
source "$E2E_LIB_DIR/style.sh"
# shellcheck source=../lib/assert.sh
source "$E2E_LIB_DIR/assert.sh"
# shellcheck source=../lib/server.sh
source "$E2E_LIB_DIR/server.sh"

# Configuration
GRADLE_PROJECT_DIR="${REPO_ROOT}/examples/gradle/simple_android_app"
SERVER_URL="${SERVER_URL:-http://localhost:8080}"

# Set the token for Gradle (the example project reads TUIST_TOKEN)
export TUIST_TOKEN="${GRADLE_TOKEN:-tuist_01234567-89ab-cdef-0123-456789abcdef_gradlecachedevtoken}"
export TUIST_CACHE_URL="${SERVER_URL}/api/cache/gradle/tuist/gradle/"

# Cleanup function
cleanup() {
    log "Cleaning up..."
    if [[ "${KEEP_SERVER:-}" != "true" ]]; then
        server_stop
    fi
}
trap cleanup EXIT

# Verify prerequisites
require_cmd java
require_cmd curl

# Check Android SDK
if [[ -z "${ANDROID_HOME:-}" ]] && [[ -d ~/Library/Android/sdk ]]; then
    export ANDROID_HOME=~/Library/Android/sdk
fi

if [[ -z "${ANDROID_HOME:-}" ]]; then
    fail "Android SDK not found. Set ANDROID_HOME or install Android Studio"
fi

assert_dir_exists "$GRADLE_PROJECT_DIR"

# Start the server if not already running
if ! server_is_running; then
    server_start "$REPO_ROOT/server"
fi

cd "$GRADLE_PROJECT_DIR"

# Clean local Gradle caches to ensure we test remote cache
log "Clearing local Gradle build caches..."
rm -rf ~/.gradle/caches/build-cache-1/* 2>/dev/null || true
rm -rf .gradle/build-cache/* 2>/dev/null || true
./gradlew clean --quiet 2>/dev/null || true

# First build: should push to cache
log "Running first build (should push to remote cache)..."
BUILD_OUTPUT=$(./gradlew assembleDebug --build-cache --info 2>&1) || {
    err "First build failed"
    echo "$BUILD_OUTPUT"
    exit 1
}

if [[ "$BUILD_OUTPUT" == *"Stored cache entry"* ]]; then
    ok "First build pushed artifacts to remote cache"
else
    warn "No 'Stored cache entry' found in build output (may already be cached)"
fi

# Clean again to force cache pull
log "Cleaning build outputs..."
./gradlew clean --quiet
rm -rf ~/.gradle/caches/build-cache-1/* 2>/dev/null || true
rm -rf .gradle/build-cache/* 2>/dev/null || true

# Second build: should pull from cache
log "Running second build (should pull from remote cache)..."
BUILD_OUTPUT=$(./gradlew assembleDebug --build-cache --info 2>&1) || {
    err "Second build failed"
    echo "$BUILD_OUTPUT"
    exit 1
}

if [[ "$BUILD_OUTPUT" == *"Loaded cache entry"* ]] && [[ "$BUILD_OUTPUT" == *"Using remote HTTP build cache"* ]]; then
    ok "Second build loaded artifacts from remote cache"
else
    err "Expected cache hits from remote server"
    echo "$BUILD_OUTPUT" | grep -E "(cache|FROM-CACHE)" || true
    exit 1
fi

# Count cache hits
CACHE_HITS=$(echo "$BUILD_OUTPUT" | grep -c "FROM-CACHE" || echo "0")
assert_gt "$CACHE_HITS" 0

ok "Gradle cache integration test passed with $CACHE_HITS cache hits"
