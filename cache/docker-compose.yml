services:
  cache:
    image: ghcr.io/tuist/cache
    container_name: cache-app
    command: ["/app/bin/cache", "start"]
    volumes:
      - cache_socket:/run/cache:rw
      - cas_data:/cas:rw
      - sqlite_data:/data:rw
    environment:
      PHX_HOST: ${PHX_HOST}
      PHX_SERVER: "true"
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      SERVER_URL: ${SERVER_URL}
      CAS_STORAGE_DIR: /cas
      PHX_SOCKET_PATH: /run/cache/cache.sock
      PHX_SOCKET_LINK: /run/cache/current.sock
      S3_BUCKET: ${S3_BUCKET}
      S3_HOST: ${S3_HOST}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_REGION: ${S3_REGION}
    networks:
      - cache_network
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: cache-nginx
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - cache_socket:/run/cache:ro
      - cas_data:/cas:ro
    depends_on:
      - cache
    networks:
      - cache_network
    restart: unless-stopped

volumes:
  cas_data:
  sqlite_data:
  cache_socket:

networks:
  cache_network:
    driver: bridge
