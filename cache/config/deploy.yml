service: cache
image: tuist/cache

servers:
  web:
    hosts:
      - 91.98.81.176
      - 5.161.218.106
    proxy: false
    options:
      network-alias: cache-app

accessories:
  caddy-us:
    image: caddy:2-alpine
    host: 5.161.218.106
    env:
      clear:
        CADDY_HOST: cache-us-east-staging.tuist.dev
    options:
      publish:
        - "80:80"
        - "443:443"
        - "443:443/udp"
    files:
      - config/Caddyfile:/etc/caddy/Caddyfile
    volumes:
      - caddy-data:/data
      - caddy-config:/config

  caddy-eu:
    image: caddy:2-alpine
    host: 91.98.81.176
    env:
      clear:
        CADDY_HOST: cache-eu-central-staging.tuist.dev
    options:
      publish:
        - "80:80"
        - "443:443"
        - "443:443/udp"
    files:
      - config/Caddyfile:/etc/caddy/Caddyfile
    volumes:
      - caddy-data:/data
      - caddy-config:/config

registry:
  server: ghcr.io
  username: cschmatzler
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64

env:
  clear:
    PHX_HOST: staging-cache.tuist.dev
    SERVER_URL: https://staging.tuist.dev
  secret:
    - SECRET_KEY_BASE

volumes:
  - /cas:/data:rw
