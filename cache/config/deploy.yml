service: cache
image: tuist/cache

servers:
  web:
    hosts:
      - 91.98.81.176
      - 5.161.218.106
    proxy: false
    options:
      network-alias: cache-app

accessories:
  nginx-us:
    image: jonasal/nginx-certbot:latest
    host: 5.161.218.106
    env:
      clear:
        CERTBOT_EMAIL: christoph@tuist.dev
    options:
      publish:
        - "80:80"
        - "443:443"
    files:
      - config/nginx-us.conf:/etc/nginx/user_conf.d/default.conf
    volumes:
      - /data/cas:/cas:ro
      - nginx-us-letsencrypt:/etc/letsencrypt

  nginx-eu:
    image: jonasal/nginx-certbot:latest
    host: 91.98.81.176
    env:
      clear:
        CERTBOT_EMAIL: christoph@tuist.dev
    options:
      publish:
        - "80:80"
        - "443:443"
    files:
      - config/nginx-eu.conf:/etc/nginx/user_conf.d/default.conf
    volumes:
      - /data/cas:/cas:ro
      - nginx-eu-letsencrypt:/etc/letsencrypt

registry:
  server: ghcr.io
  username: cschmatzler
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64

env:
  clear:
    PHX_HOST: staging-cache.tuist.dev
    SERVER_URL: https://staging.tuist.dev
  secret:
    - SECRET_KEY_BASE

volumes:
  - /data/cas:/cas:rw
