import Foundation
import ProjectDescription
import TSCBasic
import TuistCore
import TuistSupport

extension TuistCore.Config {
    /// Maps a ProjectDescription.Config instance into a TuistCore.Config model.
    /// - Parameters:
    ///   - manifest: Manifest representation of Tuist config.
    ///   - path: The path of the config file.
    static func from(manifest: ProjectDescription.Config, at path: AbsolutePath) throws -> TuistCore.Config {
        let generationOptions = try manifest.generationOptions.map { try TuistCore.Config.GenerationOption.from(manifest: $0) }
        let compatibleXcodeVersions = TuistCore.CompatibleXcodeVersions.from(manifest: manifest.compatibleXcodeVersions)
        let generatorPaths = GeneratorPaths(manifestDirectory: path)
        let plugins = try manifest.plugins.map { try PluginLocation.from(manifest: $0, generatorPaths: generatorPaths) }

        var cloud: TuistCore.Cloud?
        if let manifestCloud = manifest.cloud {
            cloud = try TuistCore.Cloud.from(manifest: manifestCloud)
        }
        return TuistCore.Config(compatibleXcodeVersions: compatibleXcodeVersions,
                                cloud: cloud,
                                plugins: plugins,
                                generationOptions: generationOptions,
                                path: path)
    }
}

extension TuistCore.Config.GenerationOption {
    /// Maps a ProjectDescription.Config.GenerationOptions instance into a TuistCore.Config.GenerationOptions model.
    /// - Parameters:
    ///   - manifest: Manifest representation of Tuist config generation options
    ///   - generatorPaths: Generator paths.
    static func from(manifest: ProjectDescription.Config.GenerationOptions) throws -> TuistCore.Config.GenerationOption {
        switch manifest {
        case let .xcodeProjectName(templateString):
            return .xcodeProjectName(templateString.description)
        case let .organizationName(name):
            return .organizationName(name)
        case let .developmentRegion(developmentRegion):
            return .developmentRegion(developmentRegion)
        case .disableAutogeneratedSchemes:
            return .disableAutogeneratedSchemes
        case .disableSynthesizedResourceAccessors:
            return .disableSynthesizedResourceAccessors
        case .disableShowEnvironmentVarsInScriptPhases:
            return .disableShowEnvironmentVarsInScriptPhases
        case .enableCodeCoverage:
            return .enableCodeCoverage
        }
    }
}

private extension TuistCore.PluginLocation {
    /// Convert from `ProjectDescription.PluginLocation` to `TuistCore.PluginLocation`
    static func from(
        manifest: ProjectDescription.PluginLocation,
        generatorPaths: GeneratorPaths
    ) throws -> TuistCore.PluginLocation {
        switch manifest.type {
        case let .local(path):
            return .local(path: try generatorPaths.resolve(path: path).pathString)
        case let .gitWithBranch(url, branch):
            return .gitWithBranch(url: url, branch: branch)
        case let .gitWithTag(url, tag):
            return .gitWithTag(url: url, tag: tag)
        case let .gitWithSha(url, sha):
            return .gitWithSha(url: url, sha: sha)
        }
    }
}
